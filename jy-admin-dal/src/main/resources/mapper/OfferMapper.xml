<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.loxf.jyadmin.dal.dao.OfferMapper" >
  <resultMap id="BaseResultMap" type="org.loxf.jyadmin.dal.po.Offer" >
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="offer_id" property="offerId" jdbcType="VARCHAR" />
    <result column="offer_name" property="offerName" jdbcType="VARCHAR" />
    <result column="catalog_id" property="catalogId" jdbcType="VARCHAR" />
    <result column="catalog_name" property="catalogName" jdbcType="VARCHAR" />
    <result column="offer_type" property="offerType" jdbcType="VARCHAR" />
    <result column="sale_money" property="saleMoney" jdbcType="DECIMAL" />
    <result column="offer_pic" property="offerPic" jdbcType="VARCHAR" />
    <result column="main_media" property="mainMedia" jdbcType="VARCHAR" />
    <result column="buy_privi" property="buyPrivi" jdbcType="VARCHAR" />
    <result column="meta_data" property="metaData" jdbcType="VARCHAR" />
    <result column="html_id" property="htmlId" jdbcType="VARCHAR" />
    <result column="status" property="status" jdbcType="INTEGER" />
    <result column="is_deleted" property="isDeleted" jdbcType="INTEGER" />
    <result column="created_at" property="createdAt" jdbcType="TIMESTAMP" />
    <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP" />
  </resultMap>
  <sql id="Base_Column_List" >
    id, offer_id, offer_name, catalog_id,
     offer_type, sale_money, offer_pic, main_media, buy_privi, meta_data, html_id, status, is_deleted, created_at, updated_at
  </sql>
  <select id="selectByOfferId" resultMap="BaseResultMap" parameterType="String" >
    select (select CATALOG_NAME from tb_offer_catalog b where b.CATALOG_id = t.CATALOG_id) as `CATALOG_NAME`, t.*
    from tb_offer t
    where offer_id = #{offerId}
  </select>

  <select id="pager" resultMap="BaseResultMap" parameterType="org.loxf.jyadmin.dal.po.Offer" >
    select (select CATALOG_NAME from tb_offer_catalog b where b.CATALOG_id = t.CATALOG_id) as `CATALOG_NAME`, t.*
    from tb_offer t
    where is_deleted = 0
    <include refid="WHERE_SQL"></include>
    order by created_at desc
    <if test="pager!=null">
      limit #{pager.start}, #{pager.size}
    </if>
  </select>

  <select id="count" resultType="int" parameterType="org.loxf.jyadmin.dal.po.Offer" >
    select count(1)
    from tb_offer
    where is_deleted = 0
    <include refid="WHERE_SQL"></include>
  </select>

  <sql id="WHERE_SQL">
    <if test="offerName!=null and offerName!=''">
      and offer_name like concat('%', #{offerName}, '%')
    </if>
    <if test="catalogId!=null and catalogId!=''">
      and catalog_id = #{catalogId}
    </if>
    <if test="offerType!=null and offerType!=''">
      and offer_type = #{offerType}
    </if>
    <if test="buyPrivi!=null and buyPrivi!=''">
      and buy_privi like concat('%', #{buyPrivi}, '%')
    </if>
    <if test="metaData!=null and metaData!=''">
      and meta_data like concat('%"', #{metaData}, '"%')
    </if>
    <if test="status!=null">
      and status = #{status}
    </if>
    <if test="startDate!=null and startDate!=''">
      and created_at >= #{startDate}
    </if>
    <if test="endDate!=null and endDate!='' ">
      and created_at &lt; date_add(#{endDate}, INTERVAL 1 DAY)
    </if>
  </sql>

  <update id="deleteByOfferId" parameterType="java.lang.String" >
    update tb_offer set is_deleted = 1
    where offer_id = #{offerId}
  </update>

  <insert id="insert" parameterType="org.loxf.jyadmin.dal.po.Offer" >
    insert into tb_offer (offer_id, offer_name,
      catalog_id, offer_type, sale_money,
      offer_pic, main_media, buy_privi,
      meta_data, html_id, status, 
      is_deleted, created_at, updated_at
      )
    values (#{offerId,jdbcType=VARCHAR}, #{offerName,jdbcType=VARCHAR},
      #{catalogId,jdbcType=VARCHAR}, #{offerType,jdbcType=VARCHAR}, #{saleMoney,jdbcType=DECIMAL},
      #{offerPic,jdbcType=DECIMAL}, #{mainMedia,jdbcType=VARCHAR}, #{buyPrivi,jdbcType=VARCHAR},
      #{metaData,jdbcType=VARCHAR}, #{htmlId,jdbcType=VARCHAR}, 0, 0, now(), now()
      )
  </insert>

  <update id="updateByOfferId" parameterType="org.loxf.jyadmin.dal.po.Offer" >
    update tb_offer
    set offer_name = #{offerName,jdbcType=VARCHAR},
      catalog_id = #{catalogId,jdbcType=VARCHAR},
      offer_type = #{offerType,jdbcType=VARCHAR},
      sale_money = #{saleMoney,jdbcType=DECIMAL},
      offer_pic = #{offerPic,jdbcType=DECIMAL},
      main_media = #{mainMedia,jdbcType=VARCHAR},
      buy_privi = #{buyPrivi,jdbcType=VARCHAR},
      meta_data = #{metaData,jdbcType=VARCHAR},
      html_id = #{htmlId,jdbcType=VARCHAR},
      updated_at = now()
    where offer_id = #{offerId,jdbcType=VARCHAR}
  </update>

  <update id="onOrOffOffer">
    update tb_offer set status = #{status} where offer_id = #{offerId}
  </update>

  <select id="pagerOfferAndActive" parameterType="String" resultMap="BaseResultMap">
    SELECT	* FROM
	(
		SELECT A.offer_name,A.offer_id,A.offer_type,a.sale_money,a.buy_privi,a.created_at
		FROM	tb_offer a	WHERE
			a.offer_type IN ('VIP', 'CLASS')	AND A.`status` = 1
			<if test="name!=null and name!=''"> and a.offer_name like concat('%', #{name}, '%')</if>
		UNION ALL
		SELECT	B.active_name AS offer_name,b.active_id AS offer_id,'ACTIVE' AS offer_type,
				b.price AS sale_money,b.active_privi AS buy_privi,b.created_at
		FROM tb_active b WHERE B.`status` = 1
            <if test="name!=null and name!=''"> and b.active_name like concat('%', #{name}, '%')</if>
	) t ORDER BY created_at DESC
  </select>

  <select id="showOfferByOfferIdAndRelType" resultMap="BaseResultMap">
    select a.sort, (select cc.CATALOG_NAME from tb_offer_catalog cc where cc.CATALOG_id = b.CATALOG_id) as `CATALOG_NAME`,
    b.offer_name,b.offer_id,b.offer_type,b.sale_money,b.buy_privi,b.created_at
    from tb_offer_rel a, tb_offer b
    where a.rel_id = b.offer_id and a.offer_type &lt;&gt;'ACTIVE' and a.offer_id = #{offerId} and  a.rel_type = #{relType}
    union all
    select a.sort, '' as `CATALOG_NAME`, c.active_name AS offer_name,c.active_id AS offer_id,'ACTIVE' AS offer_type,
    c.price AS sale_money,c.active_privi AS buy_privi,c.created_at
    from tb_offer_rel a, tb_active c
    where a.rel_id = c.active_id and a.offer_type='ACTIVE' and a.offer_id = #{offerId} and  a.rel_type = #{relType}
    order by sort
  </select>
</mapper>