<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
    <legend>修改套餐</legend>
</fieldset>

<form class="layui-form" action="">
    <div class="layui-form-item">
        <label class="layui-form-label">套餐名称</label>
        <div class="layui-input-block">
            <input type="text" name="offerName" value="$!{offer.offerName}" lay-verify="offerName" autocomplete="off" placeholder="请输入套餐名称（建议20字以内）"
                   class="layui-input">
            <input type="hidden" name="offerId" lay-verify="offerId" value="$!{offer.offerId}">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label">商品分类</label>
            <div class="layui-input-inline">
                <select name="catalogId" id="catalogId" lay-search=""><!-- lay-verify="required" -->
                    <option value="">选择/搜索商品分类</option>
                    #foreach($item in $catalogDtos)
                        <option value="$!{item.catalogId}" #if($!{item.catalogId}==$!{offer.catalogId}) selected #end>$!{item.catalogName}</option>
                    #end
                </select>
            </div>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">套餐价格</label>
        <div class="layui-input-block">
            <input type="text" name="saleMoney" value="$!{offer.saleMoney}" style="width: 120px" lay-verify="required" placeholder="￥" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">购买权限</label>
        <div class="layui-input-block">
            <input type="checkbox" value="NONE" #if(${buyJson} && ${buyJson.NONE} ) checked #end title="普通">
            <input type="checkbox" value="VIP" #if(${buyJson} && ${buyJson.VIP} ) checked #end title="VIP">
            <input type="checkbox" value="SVIP" #if(${buyJson} && ${buyJson.SVIP} ) checked #end title="SVIP">
        </div>
    </div>
    <div class="layui-form-item noneDiv" #if(${buyJson} && ${buyJson.NONE} )  style="display: block" #else  style="display: none" #end>
        <label class="layui-form-label">普通价格</label>
        <input type="text"  style="width: 120px" name="buyPrivi_NONE" placeholder="￥"
            #if(${buyJson} && ${buyJson.NONE} ) value="$!{buyJson.NONE}" #end autocomplete="off" class="layui-input">
    </div>
    <div class="layui-form-item vipDiv" #if(${buyJson} && ${buyJson.VIP}) style="display: block" #else  style="display: none" #end>
        <label class="layui-form-label">VIP价格</label>
        <input type="text"  style="width: 120px" name="buyPrivi_VIP" placeholder="￥"
            #if(${buyJson} && ${buyJson.VIP} ) value="$!{buyJson.VIP}" #end autocomplete="off" class="layui-input">
    </div>
    <div class="layui-form-item svipDiv" #if(${buyJson} && ${buyJson.SVIP} ) style="display: block" #else  style="display: none" #end>
        <label class="layui-form-label">SVIP价格</label>
        <input type="text"  style="width: 120px" name="buyPrivi_SVIP" placeholder="￥"
            #if(${buyJson} && ${buyJson.SVIP} ) value="$!{buyJson.SVIP}" #end  autocomplete="off" class="layui-input">
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">商品图片</label>
        <a class="layui-btn uploadImg" id="offerPicBtn" lay-data="{url: '${rc.contextPath}/upload/img.html?type=OFFER'}">
            <i class="layui-icon">&#xe62f;</i>上传商品图片（宽300*高180）</a>
        <input type="hidden" name="offerPic" value="$!{offer.offerPic}" id="offerPic">
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">图片预览</label>
        <div class="layui-upload-list">
            <img class="layui-upload-img" style="width: 300px; height: 180px" id="offerPicImg"
                #if(${offer.offerPic}) src="$!{basePic}$!{offer.offerPic}" #end >
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">套餐内容</label>
        <div class="layui-input-block">
            <table class="layui-table" id="offerList" lay-filter="offerListFilter"></table>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">热门商品</label>
        <div class="layui-input-block">
            <input type="checkbox" checked="" name="HOT"
                #if(${metaDataJson} && ${metaDataJson.HOT} ) checked #end lay-skin="switch" lay-text="ON|OFF">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">首页展示</label>
        <div class="layui-input-block">
            <input type="checkbox" #if(${metaDataJson} && ${metaDataJson.INDEX} ) checked #end
                   name="INDEX" lay-skin="switch" lay-text="ON|OFF">
        </div>
    </div>
    <div class="layui-form-item layui-form-text">
        <label class="layui-form-label">套餐详情</label>
        #parse("/views/common/editor.vm")
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit="" lay-filter="offerData">修改套餐</button>
        </div>
    </div>
</form>

<script type="text/html" id="offerTypeTpl">
    {{#  if(d.offerType==='VIP'){ }}
    服务
    {{#  } else if(d.offerType==='CLASS'){ }}
    课程类型
    {{#  } else if(d.offerType==='OFFER'){ }}
    套餐
    {{#  } else if(d.offerType==='ACTIVE'){ }}
    活动
    {{#  } }}
</script>

<script type="text/html" id="buyPriviTpl">
    {{#  if(d.buyPrivi){ }}
    {{#  var result = "", json = eval("("+d.buyPrivi+")"); result += (json.NONE?" 普通：" + json.NONE:""); result += (json.VIP?" VIP：" + json.VIP:""); result += (json.SVIP?" SVIP：" + json.SVIP:"");}}
    {{#  return result; }}
    {{#  } else { }}
    不允许直接购买
    {{#  } }}
</script>
<script>
    var form = layui.form
            ,layer = layui.layer
            ,upload = layui.upload
            ,table = layui.table;

    //监听表格复选框选择
    table.on('checkbox(offerListFilter)', function(obj){
    });

    table.render({ //其它参数在此省略
        url: 'simpleOfferList.html',
        id:'offerList',
        method: 'POST',
        elem: '#offerList', //指定原始表格元素选择器（推荐id选择器）
        height: 280, //容器高度
        cols: [[
            {checkbox:true, fixed: true},
            {
                field: 'sort',
                title: '顺序',
                edit:'text',
                style:'background-color: #009688; color: #fff;',
                width: 80
            },
            {
                field: 'offerName',
                title: '商品/活动',
                width: 280
            },
            {
                field: 'offerType',
                title: '类型',
                width: 100,
                templet:'#offerTypeTpl'
            },
            {
                field: 'saleMoney',
                title: '价格',
                width: 80
            },
            {
                field: 'buyPrivi',
                title: '售价',
                width: 260,
                templet:'#buyPriviTpl'
            }
        ]],
        request: {
            pageName: 'page', //页码的参数名称，默认：page
            limitName: 'size' //每页数据量的参数名，默认：limit
        },
        response: {
            statusName: 'code', //数据状态的字段名称，默认：code
            statusCode: 1, //成功的状态码，默认：0
            msgName: 'msg', //状态信息的字段名称，默认：msg
            countName: 'total', //数据总数的字段名称，默认：count
            dataName: 'data' //数据列表的字段名称，默认：data
        },
        even: true
    });
    //同时绑定多个元素，并将属性设定在元素上
    upload.render({
        elem: '.uploadImg'
        ,size : 3072
        ,accept: 'images'
        ,before: function(obj){
            var name = this.item.attr("id");
            name = name.replace('Btn', 'Img')
            obj.preview(function(index, file, result){
                $('#'+name).attr('src', result); //图片链接（base64）
            });
        }
        ,done: function(res, index, upload){
            if(res.code===1){
                var name = this.item.attr("id");
                name = name.replace('Btn', '');
                $('#'+name).val(res.data.src);
            } else {
                layer.tips(res.msg);
            }
        }
    });

    //自定义验证规则
    form.verify({
        offerName: function(value){
            if(value.length < 4){
                return '标题至少4个字';
            } else if(value.length >20){
                return '标题超过20个字';
            }
        }
    });

    //监听提交
    form.on('submit(offerData)', function(data){
        parent.layer.confirm('修改套餐时商品及其顺序必须重新设置，确认修改？', {icon: 3, title:'警告'}, function(index) {
            var checkStatus = table.checkStatus('offerList')
                    , relData = checkStatus.data;
            var childOffer = [];
            if (relData && relData.length) {
                for (var idx in relData) {
                    childOffer.push({
                        relId: relData[idx].offerId,
                        offerType: relData[idx].offerType,
                        relType: 'OFFER',
                        sort: relData[idx].sort == undefined ? 50 : relData[idx].sort
                    });
                }
            } else {
                parent.layer.msg("请选择套餐内容");
            }
            var htmlId = saveHtml(data.field.htmlId);
            if (!htmlId) {
                return false;
            }
            var buyPrivi = {};
            if (data.field.buyPrivi_NONE) {
                buyPrivi.NONE = data.field.buyPrivi_NONE;
            }
            if (data.field.buyPrivi_VIP) {
                buyPrivi.VIP = data.field.buyPrivi_VIP;
            }
            if (data.field.buyPrivi_SVIP) {
                buyPrivi.SVIP = data.field.buyPrivi_SVIP;
            }
            var metaData = {
                HOT: data.field.HOT,
                INDEX: data.field.INDEX
            };

            $.ajax({
                type: "POST",
                url: "editOffer.html",
                data: {
                    offerId: data.field.offerId,
                    offerName: data.field.offerName,
                    catalogId: data.field.catalogId,
                    offerPic: data.field.offerPic,
                    buyPrivi: JSON.stringify(buyPrivi),
                    metaData: JSON.stringify(metaData),
                    saleMoney: data.field.saleMoney,
                    offerType: 'OFFER',
                    htmlId: htmlId,
                    relOfferStr: JSON.stringify(childOffer)
                },
                dataType: "json",
                success: function (data) {
                    if (data.code == 1) {
                        parent.searchList();
                        parent.layer.closeAll();
                    } else {
                        parent.layer.msg(data.msg);
                    }
                }
            });
            return false;
        });
        return false;
    });

    //购买权限控制
    form.on('checkbox', function(data){
        if(data.value=='NONE'){
            if(data.elem.checked){
                $(".noneDiv").show();
            } else {
                $(".noneDiv").hide();
            }
        } else if(data.value=='VIP'){
            if(data.elem.checked){
                $(".vipDiv").show();
            } else {
                $(".vipDiv").hide();
            }
        } else if(data.value=='SVIP'){
            if(data.elem.checked){
                $(".svipDiv").show();
            } else {
                $(".svipDiv").hide();
            }
        }
    });

    form.render();
</script>
